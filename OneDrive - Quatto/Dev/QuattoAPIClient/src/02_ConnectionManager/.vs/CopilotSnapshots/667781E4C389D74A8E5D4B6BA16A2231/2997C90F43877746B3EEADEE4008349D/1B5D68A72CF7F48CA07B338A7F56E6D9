name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: Build (Windows, .NET Framework / net472)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Chocolatey packages (nuget)
        shell: pwsh
        run: |
          choco feature enable -n=allowGlobalConfirmation
          choco install nuget.commandline -y

      - name: Check for SSIS assemblies on runner
        shell: pwsh
        run: |
          $paths = @(
            'C:\\Program Files\\Microsoft SQL Server\\150\\DTS\\Binn\\Microsoft.SqlServer.ManagedDTS.dll',
            'C:\\Program Files\\Microsoft SQL Server\\140\\DTS\\Binn\\Microsoft.SqlServer.ManagedDTS.dll',
            'C:\\Program Files\\Microsoft SQL Server\\160\\DTS\\Binn\\Microsoft.SqlServer.ManagedDTS.dll'
          )
          $found = $false
          foreach ($p in $paths) { if (Test-Path $p) { Write-Host "Found SSIS assembly: $p"; $found = $true; break } }
          if ($found) { echo "SSIS_PRESENT=true" >> $env:GITHUB_ENV } else { echo "SSIS_PRESENT=false" >> $env:GITHUB_ENV; Write-Host "SSIS assemblies not found on runner. Build will use no-SSIS stubs." }

      - name: Setup .NET SDK (CLI for restore/build)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore NuGet packages
        run: |
          dotnet restore src/02_ConnectionManager/QuattoAPIClient.ConnectionManager.csproj

      - name: Build (conditional SSIS)
        shell: pwsh
        run: |
          if ($env:SSIS_PRESENT -eq 'true') {
            Write-Host "Building with SSIS types (DEFINE USE_SSIS)"
            dotnet build src/02_ConnectionManager/QuattoAPIClient.ConnectionManager.csproj -c Release -p:SqlServerVersion=150 -p:DefineConstants="USE_SSIS"
          } else {
            Write-Host "Building without SSIS types (using stubs)"
            dotnet build src/02_ConnectionManager/QuattoAPIClient.ConnectionManager.csproj -c Release -p:SqlServerVersion=150
          }

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: QuattoAPIClient-Bins
          path: |
            src/**/bin/Release/
