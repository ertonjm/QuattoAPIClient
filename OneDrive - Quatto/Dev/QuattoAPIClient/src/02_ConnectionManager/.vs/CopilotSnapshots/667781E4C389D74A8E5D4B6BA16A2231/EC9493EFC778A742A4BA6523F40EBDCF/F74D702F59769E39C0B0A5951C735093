name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: Build (Windows, .NET Framework / net472)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Chocolatey packages (nuget)
        shell: pwsh
        run: |
          choco feature enable -n=allowGlobalConfirmation
          choco install nuget.commandline -y

      - name: Setup .NET SDK (CLI for restore/build)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore NuGet packages
        run: |
          dotnet restore src/02_ConnectionManager/QuattoAPIClient.ConnectionManager.csproj

      - name: Build (no-SSIS, uses stubs when SSIS not installed)
        run: |
          dotnet build src/02_ConnectionManager/QuattoAPIClient.ConnectionManager.csproj -c Release -p:SqlServerVersion=150

      - name: Verify presence of SSIS assembly (optional)
        if: always()
        shell: pwsh
        run: |
          $paths = @(
            'C:\\Program Files\\Microsoft SQL Server\\150\\DTS\\Binn\\Microsoft.SqlServer.ManagedDTS.dll',
            'C:\\Program Files\\Microsoft SQL Server\\140\\DTS\\Binn\\Microsoft.SqlServer.ManagedDTS.dll',
            'C:\\Program Files\\Microsoft SQL Server\\160\\DTS\\Binn\\Microsoft.SqlServer.ManagedDTS.dll'
          )
          $found = $false
          foreach ($p in $paths) { if (Test-Path $p) { Write-Host "Found SSIS assembly: $p"; $found = $true; break } }
          if (-not $found) { Write-Host "SSIS assemblies not found on runner. Build used no-SSIS stubs. To build with real SSIS types, install SSIS on the runner or provide the assembly." }

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: QuattoAPIClient-ConnectionManager
          path: src/02_ConnectionManager/bin/Release/
